<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Library — Студент</title>
    <style>
        :root{
          --border: 4px solid #000;
          --w: 980px;
        }
        *{ box-sizing:border-box; }
        body{
          margin:0;
          background:#fff;
          color:#000;
          font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        }
        .page{
          min-height:100vh;
          display:flex;
          justify-content:center;
          padding:48px 20px;
        }
        .wrap{ width: min(var(--w), 100%); }

        .topbar{
          display:flex;
          align-items:flex-end;
          justify-content:space-between;
          gap:16px;
          margin-bottom:22px;
        }
        .title{
          margin:0;
          font-size:56px;
          font-weight:800;
          letter-spacing:.3px;
          line-height:1;
        }
        .who{
          text-align:right;
          font-weight:900;
          font-size:18px;
          line-height:1.2;
        }

        .tabs{
          display:flex;
          gap:12px;
          margin-bottom:16px;
          flex-wrap:wrap;
        }
        .tab{
          border: var(--border);
          background:#fff;
          color:#000;
          padding:10px 14px;
          font-weight:900;
          font-size:18px;
          cursor:pointer;
          user-select:none;
        }
        .tab.active{
          background:#000;
          color:#fff;
        }

        .panel{
          border: var(--border);
          padding:18px;
          display:none;
        }
        .panel.active{ display:block; }

        .row{
          display:grid;
          grid-template-columns: 1fr 1fr 180px 220px;
          gap:12px;
          margin-bottom:14px;
        }
        @media (max-width: 900px){
          .row{ grid-template-columns: 1fr 1fr; }
        }
        @media (max-width: 520px){
          .row{ grid-template-columns: 1fr; }
          .topbar{ flex-direction:column; align-items:flex-start; }
          .who{ text-align:left; }
        }

        .field{
          width:100%;
          border: var(--border);
          padding:12px 14px;
          font-size:16px;
          font-weight:900;
          outline:none;
          background:#fff;
          color:#000;
        }
        .field::placeholder{
          color:#000;
          opacity:1;
          font-weight:900;
        }

        .btns{
          display:flex;
          gap:12px;
          margin: 10px 0 18px;
          flex-wrap:wrap;
        }
        .btn{
          border: var(--border);
          background:#fff;
          color:#000;
          padding:12px 14px;
          font-weight:900;
          font-size:16px;
          cursor:pointer;
          user-select:none;
        }
        .btn:hover{ background:#000; color:#fff; }

        .btn-small{
          border: 3px solid #000;
          background:#fff;
          color:#000;
          padding:8px 10px;
          font-weight:900;
          font-size:14px;
          cursor:pointer;
          white-space:nowrap;
        }
        .btn-small:hover{ background:#000; color:#fff; }
        .btn-small[disabled]{
          opacity:.55;
          cursor:not-allowed;
        }
        .btn-small[disabled]:hover{
          background:#fff; color:#000;
        }

        .meta{
          display:flex;
          gap:12px;
          align-items:center;
          flex-wrap:wrap;
          font-weight:900;
          margin-bottom:12px;
        }
        .pill{
          border: var(--border);
          padding:8px 12px;
          font-weight:900;
        }
        .muted{ opacity:.85; }

        .notice{
          border: var(--border);
          padding:12px 14px;
          font-weight:900;
          margin: 0 0 14px 0;
          display:none;
          background:#ccffcc;
        }

        .table-wrap{
          border: var(--border);
          overflow:auto;
          background:#fff;
        }
        table{
          width:100%;
          border-collapse:collapse;
          min-width: 980px;
        }
        th, td{
          border-bottom: 3px solid #000;
          padding:10px 12px;
          text-align:left;
          vertical-align:top;
          font-weight:900;
        }
        th{
          position:sticky;
          top:0;
          background:#fff;
          z-index:1;
          font-weight:900;
        }
        tr:last-child td{ border-bottom:none; }

        .link{
          display:inline-block;
          margin-top:16px;
          font-weight:900;
          color:#1f45ff;
          text-decoration:none;
        }
        .link:hover{ text-decoration:underline; }

        tr.overdue-row td{
          background:#000;
          color:#fff;
        }
        .status-pill{
          display:inline-block;
          padding:6px 10px;
          border:3px solid #000;
          font-weight:900;
          white-space:nowrap;
        }
        .status-pill.ok{
          background:#fff;
          color:#000;
        }
        .status-pill.overdue{
          background:#000;
          color:#fff;
        }
        .status-pill.paid{
          background:#fff;
          color:#000;
          border-style:dashed;
        }

        .p{
          border: var(--border);
          padding:8px 12px;
          font-weight:900;
        }
    </style>
</head>
<body>
<main class="page">
    <section class="wrap" aria-label="Кабинет студента">
        <div class="topbar">
            <h1 class="title">Library</h1>
            <div class="who">Студент</div>
        </div>

        <div class="tabs" role="tablist" aria-label="Навигация">
            <button class="tab active" id="tabSearch" type="button" role="tab" aria-selected="true">Поиск книг</button>
            <button class="tab" id="tabCatalog" type="button" role="tab" aria-selected="false">Каталог</button>
            <button class="tab" id="tabLoans" type="button" role="tab" aria-selected="false">Мои выдачи</button>
        </div>

        <!-- Поиск -->
        <div class="panel active" id="panelSearch" role="tabpanel" aria-labelledby="tabSearch">
            <div class="notice" id="noticeSearch"></div>
            <div class="row">
                <input class="field" id="qTitle"  type="text" placeholder="Название (часть)" />
                <input class="field" id="qAuthor" type="text" placeholder="Автор (часть)" />
                <input class="field" id="qYear"   type="number" placeholder="Год" />
                <input class="field" id="qIsbn"   type="text" placeholder="ISBN (например ISBN001)" />
            </div>
            <div class="btns">
                <button class="btn" id="btnSearch" type="button">Искать</button>
                <button class="btn" id="btnReset" type="button">Сброс</button>
                <button class="btn" id="btnShowAll" type="button">Показать все</button>
            </div>
            <div class="meta">
                <div class="p" id="searchCount">Найдено: 0</div>
                <div class="p" id="totalCount">Всего в каталоге: 0</div>
                <div class="p" id="myLoansPill">Мои выдачи: 0</div>
                <div class="p" id="myOverduePill">Просрочено: 0</div>
                <div class="p" id="myFinePill">Штраф: 0 ₽</div>
            </div>
            <div class="table-wrap" aria-label="Результаты поиска">
                <table>
                    <thead>
                    <tr>
                        <th>ISBN</th><th>Название</th><th>Автор</th><th>Год</th><th>Тип</th><th>Издательство</th><th>Доступно</th><th>Действие</th>
                    </tr>
                    </thead>
                    <tbody id="searchBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Каталог -->
        <div class="panel" id="panelCatalog" role="tabpanel" aria-labelledby="tabCatalog">
            <div class="notice" id="noticeCatalog"></div>
            <div class="meta">
                <div class="p" id="catalogCount">Книг: 0</div>
                <div class="p" id="catalogLoansPill">Мои выдачи: 0</div>
                <div class="p" id="catalogOverduePill">Просрочено: 0</div>
                <div class="p" id="catalogFinePill">Штраф: 0 ₽</div>
            </div>
            <div class="table-wrap" aria-label="Каталог книг">
                <table>
                    <thead>
                    <tr>
                        <th>ISBN</th><th>Название</th><th>Автор</th><th>Год</th><th>Тип</th><th>Доп. инфо</th><th>Доступно</th><th>Действие</th>
                    </tr>
                    </thead>
                    <tbody id="catalogBody"></tbody>
                </table>
            </div>
            <a class="link" href="login.html">Выйти (назад на вход)</a>
        </div>

        <!-- Мои выдачи -->
        <div class="panel" id="panelLoans" role="tabpanel" aria-labelledby="tabLoans">
            <div class="notice" id="noticeLoans"></div>
            <div class="meta">
                <div class="pill" id="loansCount">Выдач: 0</div>
                <div class="pill" id="loansOverdueCount">Просрочено: 0</div>
                <div class="pill" id="loansFineTotal">Штраф: 0 ₽</div>
            </div>
            <div class="table-wrap" aria-label="Мои выдачи книг">
                <table>
                    <thead>
                    <tr>
                        <th>ISBN</th><th>Название</th><th>Автор</th><th>Дата выдачи</th><th>Срок возврата</th><th>Статус</th><th>Штраф</th><th>Оплата</th><th>Действие</th>
                    </tr>
                    </thead>
                    <tbody id="loansBody"></tbody>
                </table>
            </div>
        </div>

    </section>
</main>

<script>
    const API_URL = 'http://localhost:8080/api';
    const FINE_PER_DAY = 10;

    function checkAuth() {
      const sessionId = localStorage.getItem('sessionId');
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      if (!sessionId || !user.userId) {
        window.location.href = 'login.html';
        return null;
      }
      return { sessionId, user };
    }
    
    const auth = checkAuth();
    if (auth) {
      document.querySelector('.who').textContent = `${auth.user.userType}\n${auth.user.name}`;
    }

    const LS_BOOKS = "library_books_cache_v1";
    const LS_LOANS = "library_loans_cache_v1";

    async function loadBooksFromAPI() {
      try {
        const response = await fetch(`${API_URL}/books`);
        const data = await response.json();
        localStorage.setItem(LS_BOOKS, JSON.stringify(data));
        return data;
      } catch (error) {
        console.error('Ошибка загрузки книг:', error);
        const cached = localStorage.getItem(LS_BOOKS);
        return cached ? JSON.parse(cached) : [];
      }
    }

    async function loadLoansFromAPI() {
      try {
        if (!auth) return [];
        const response = await fetch(`${API_URL}/loans/user/${auth.user.userId}`);
        const data = await response.json();
        localStorage.setItem(LS_LOANS, JSON.stringify(data));
        return data;
      } catch (error) {
        const cached = localStorage.getItem(LS_LOANS);
        return cached ? JSON.parse(cached) : [];
      }
    }

    let BOOKS = [];
    let LOANS = [];

    function escapeHtml(s){
      return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
    }

    function formatDate(d){
      const date = new Date(d);
      const dd = String(date.getDate()).padStart(2,'0');
      const mm = String(date.getMonth()+1).padStart(2,'0');
      const yyyy = date.getFullYear();
      return `${dd}.${mm}.${yyyy}`;
    }

    function normalize(s){ return String(s).trim().toLowerCase(); }
    function findBook(isbn){ return BOOKS.find(b => b.isbn === isbn); }
    function isOverdue(loan){ return new Date(loan.dueAt) < new Date(); }
    function overdueDays(loan){
      const due = new Date(loan.dueAt).getTime();
      const now = Date.now();
      if (now <= due) return 0;
      return Math.ceil((now - due) / (1000 * 60 * 60 * 24));
    }
    function calcFine(loan){ 
      if (!isOverdue(loan)) return 0;
      return overdueDays(loan) * FINE_PER_DAY; 
    }
    function countOverdueUnpaid(){ 
      return LOANS.filter(l => isOverdue(l) && !l.finePaid).length; 
    }
    function totalFineUnpaid(){
      return LOANS.reduce((sum, l) => sum + (l.finePaid ? 0 : calcFine(l)), 0);
    }
    function showNotice(el, text){
      el.textContent = text;
      el.style.display = 'block';
      setTimeout(() => { el.style.display = 'none'; }, 4500);
    }

    function updatePills(){
      document.getElementById('totalCount').textContent = `Всего в каталоге: ${BOOKS.length}`;
      document.getElementById('myLoansPill').textContent = `Мои выдачи: ${LOANS.length}`;
      document.getElementById('catalogLoansPill').textContent = `Мои выдачи: ${LOANS.length}`;
      document.getElementById('loansCount').textContent = `Выдач: ${LOANS.length}`;

      const overdue = countOverdueUnpaid();
      const fine = totalFineUnpaid();

      document.getElementById('myOverduePill').textContent = `Просрочено: ${overdue}`;
      document.getElementById('myFinePill').textContent = `Штраф: ${fine} ₽`;
      document.getElementById('catalogOverduePill').textContent = `Просрочено: ${overdue}`;
      document.getElementById('catalogFinePill').textContent = `Штраф: ${fine} ₽`;
      document.getElementById('loansOverdueCount').textContent = `Просрочено: ${overdue}`;
      document.getElementById('loansFineTotal').textContent = `Штраф: ${fine} ₽`;
    }

    async function borrowBook(isbn){
      if (!auth) return;
      try {
        const response = await fetch(`${API_URL}/loans/borrow?userId=${auth.user.userId}&isbn=${isbn}`, {
          method: 'POST'
        });
        const loan = await response.json();
        LOANS.push(loan);
        localStorage.setItem(LS_LOANS, JSON.stringify(LOANS));
        const book = findBook(isbn);
        if (book) book.availableCopies--;
        showNotice(document.getElementById('noticeSearch'), `Книга "${book?.title}" выдана.`);
        rerenderAll();
      } catch (error) {
        showNotice(document.getElementById('noticeSearch'), 'Ошибка при займе книги');
      }
    }

    async function returnLoan(loanId){
      if (!auth) return;
      try {
        await fetch(`${API_URL}/loans/return?loanId=${loanId}`, { method: 'POST' });
        const idx = LOANS.findIndex(x => x.id === loanId);
        if (idx !== -1) {
          const loan = LOANS[idx];
          const book = findBook(loan.isbn);
          if (book) book.availableCopies++;
          LOANS.splice(idx, 1);
          localStorage.setItem(LS_LOANS, JSON.stringify(LOANS));
          showNotice(document.getElementById('noticeLoans'), `Книга "${loan.title}" возвращена.`);
          rerenderAll();
        }
      } catch (error) {
        showNotice(document.getElementById('noticeLoans'), 'Ошибка при возврате книги');
      }
    }

    async function payFine(loanId){
      if (!auth) return;
      try {
        const idx = LOANS.findIndex(x => x.id === loanId);
        if (idx === -1) return;
        const loan = LOANS[idx];
        const fine = calcFine(loan);
        await fetch(`${API_URL}/loans/pay-fine?loanId=${loanId}&amount=${fine}`, { method: 'POST' });
        loan.finePaid = true;
        localStorage.setItem(LS_LOANS, JSON.stringify(LOANS));
        showNotice(document.getElementById('noticeLoans'), `Штраф ${fine} ₽ оплачен.`);
        rerenderAll();
      } catch (error) {
        showNotice(document.getElementById('noticeLoans'), 'Ошибка при оплате штрафа');
      }
    }

    const catalogBody = document.getElementById('catalogBody');
    const searchBody = document.getElementById('searchBody');
    const loansBody = document.getElementById('loansBody');
    const searchCount = document.getElementById('searchCount');

    function renderCatalog(){
      catalogBody.innerHTML = BOOKS.map(b => {
        const available = `${b.availableCopies}/${b.totalCopies}`;
        const disabled = b.availableCopies <= 0 ? "disabled" : "";
        return `<tr><td>${escapeHtml(b.isbn)}</td><td>${escapeHtml(b.title)}</td><td>${escapeHtml(b.author)}</td><td>${escapeHtml(b.year)}</td><td>${escapeHtml(b.type)}</td><td>${escapeHtml(b.info || '')}</td><td>${available}</td><td><button class="btn-small" ${disabled} data-action="borrow" data-isbn="${escapeHtml(b.isbn)}">Взять</button></td></tr>`;
      }).join('');
    }

    function renderSearch(rows){
      searchBody.innerHTML = rows.map(b => {
        const available = `${b.availableCopies}/${b.totalCopies}`;
        const disabled = b.availableCopies <= 0 ? "disabled" : "";
        return `<tr><td>${escapeHtml(b.isbn)}</td><td>${escapeHtml(b.title)}</td><td>${escapeHtml(b.author)}</td><td>${escapeHtml(b.year)}</td><td>${escapeHtml(b.type)}</td><td>${escapeHtml(b.publisher)}</td><td>${available}</td><td><button class="btn-small" ${disabled} data-action="borrow" data-isbn="${escapeHtml(b.isbn)}">Взять</button></td></tr>`;
      }).join('');
      searchCount.textContent = `Найдено: ${rows.length}`;
    }

    function renderLoans(){
      loansBody.innerHTML = LOANS.map(l => {
        const bAt = formatDate(l.borrowedAt);
        const dAt = formatDate(l.dueAt);
        const overdue = isOverdue(l);
        const fine = calcFine(l);
        const unpaidFine = (!l.finePaid && fine > 0);
        const statusHtml = overdue ? (l.finePaid ? `<span class="status-pill paid">ПРОСРОЧЕНО • ОПЛАЧЕНО</span>` : `<span class="status-pill overdue">ПРОСРОЧЕНО</span>`) : `<span class="status-pill ok">ОК</span>`;
        const payBtn = unpaidFine ? `<button class="btn-small" data-action="pay" data-loan-id="${escapeHtml(l.id)}">Оплатить</button>` : `<button class="btn-small" disabled>Оплатить</button>`;
        const rowClass = overdue ? "overdue-row" : "";
        return `<tr class="${rowClass}"><td>${escapeHtml(l.isbn)}</td><td>${escapeHtml(l.title)}</td><td>${escapeHtml(l.author)}</td><td>${escapeHtml(bAt)}</td><td>${escapeHtml(dAt)}</td><td>${statusHtml}</td><td>${overdue ? `${l.finePaid ? "0" : fine} ₽` : "0 ₽"}</td><td>${payBtn}</td><td><button class="btn-small" data-action="return" data-loan-id="${escapeHtml(l.id)}">Вернуть</button></td></tr>`;
      }).join('');
    }

    const tabSearch = document.getElementById('tabSearch');
    const tabCatalog = document.getElementById('tabCatalog');
    const tabLoans = document.getElementById('tabLoans');
    const panelSearch = document.getElementById('panelSearch');
    const panelCatalog = document.getElementById('panelCatalog');
    const panelLoans = document.getElementById('panelLoans');

    function setTab(which){
      const isSearch = which === 'search';
      const isCatalog = which === 'catalog';
      const isLoans = which === 'loans';
      tabSearch.classList.toggle('active', isSearch);
      tabCatalog.classList.toggle('active', isCatalog);
      tabLoans.classList.toggle('active', isLoans);
      tabSearch.setAttribute('aria-selected', String(isSearch));
      tabCatalog.setAttribute('aria-selected', String(isCatalog));
      tabLoans.setAttribute('aria-selected', String(isLoans));
      panelSearch.classList.toggle('active', isSearch);
      panelCatalog.classList.toggle('active', isCatalog);
      panelLoans.classList.toggle('active', isLoans);
    }

    tabSearch.addEventListener('click', () => setTab('search'));
    tabCatalog.addEventListener('click', () => setTab('catalog'));
    tabLoans.addEventListener('click', () => setTab('loans'));

    const qTitle = document.getElementById('qTitle');
    const qAuthor = document.getElementById('qAuthor');
    const qYear = document.getElementById('qYear');
    const qIsbn = document.getElementById('qIsbn');
    const btnSearch = document.getElementById('btnSearch');
    const btnReset = document.getElementById('btnReset');
    const btnShowAll = document.getElementById('btnShowAll');

    function doSearch(){
      const t = normalize(qTitle.value);
      const a = normalize(qAuthor.value);
      const y = normalize(qYear.value);
      const i = normalize(qIsbn.value);
      const res = BOOKS.filter(b => {
        const okTitle  = !t || normalize(b.title).includes(t);
        const okAuthor = !a || normalize(b.author).includes(a);
        const okYear   = !y || String(b.year) === String(y);
        const okIsbn   = !i || normalize(b.isbn).includes(i);
        return okTitle && okAuthor && okYear && okIsbn;
      });
      renderSearch(res);
    }

    function resetSearch(){
      qTitle.value = "";
      qAuthor.value = "";
      qYear.value = "";
      qIsbn.value = "";
      searchBody.innerHTML = "";
      searchCount.textContent = "Найдено: 0";
    }

    btnSearch.addEventListener('click', doSearch);
    btnReset.addEventListener('click', resetSearch);
    btnShowAll.addEventListener('click', () => renderSearch(BOOKS));
    [qTitle, qAuthor, qYear, qIsbn].forEach(el => {
      el.addEventListener('keydown', (e) => { if (e.key === 'Enter') doSearch(); });
    });

    document.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-action]');
      if (!btn) return;
      const action = btn.getAttribute('data-action');
      if (action === 'borrow') borrowBook(btn.getAttribute('data-isbn'));
      if (action === 'return') returnLoan(btn.getAttribute('data-loan-id'));
      if (action === 'pay') payFine(btn.getAttribute('data-loan-id'));
    });

    function rerenderAll(){
      updatePills();
      renderCatalog();
      const hasQuery = normalize(qTitle.value) || normalize(qAuthor.value) || normalize(qYear.value) || normalize(qIsbn.value);
      if (hasQuery) doSearch();
      else if (searchBody.children.length > 0) renderSearch(BOOKS);
      renderLoans();
    }

    async function init() {
      BOOKS = await loadBooksFromAPI();
      LOANS = await loadLoansFromAPI();
      updatePills();
      renderCatalog();
      renderLoans();
      document.getElementById('totalCount').textContent = `Всего в каталоге: ${BOOKS.length}`;
    }

    init();
</script>
</body>
</html>
