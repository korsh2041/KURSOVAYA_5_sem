<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Library — Библиотекарь</title>
    <style>
        :root{
          --border: 4px solid #000;
          --w: 980px;
        }
        *{ box-sizing:border-box; }
        body{
          margin:0;
          background:#fff;
          color:#000;
          font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        }
        .page{
          min-height:100vh;
          display:flex;
          justify-content:center;
          padding:48px 20px;
        }
        .wrap{ width: min(var(--w), 100%); }

        .topbar{
          display:flex;
          align-items:flex-end;
          justify-content:space-between;
          gap:16px;
          margin-bottom:22px;
        }
        .title{
          margin:0;
          font-size:56px;
          font-weight:800;
          letter-spacing:.3px;
          line-height:1;
        }
        .who{
          text-align:right;
          font-weight:900;
          font-size:18px;
          line-height:1.2;
        }

        .tabs{
          display:flex;
          gap:12px;
          margin-bottom:16px;
          flex-wrap:wrap;
        }
        .tab{
          border: var(--border);
          background:#fff;
          color:#000;
          padding:10px 14px;
          font-weight:900;
          font-size:18px;
          cursor:pointer;
          user-select:none;
        }
        .tab.active{
          background:#000;
          color:#fff;
        }

        .panel{
          border: var(--border);
          padding:18px;
          display:none;
        }
        .panel.active{ display:block; }

        .row{
          display:grid;
          grid-template-columns: 1fr 1fr 200px;
          gap:12px;
          margin-bottom:14px;
        }
        @media (max-width: 900px){
          .row{ grid-template-columns: 1fr 1fr; }
        }
        @media (max-width: 520px){
          .row{ grid-template-columns: 1fr; }
          .topbar{ flex-direction:column; align-items:flex-start; }
          .who{ text-align:left; }
        }

        .field{
          width:100%;
          border: var(--border);
          padding:12px 14px;
          font-size:16px;
          font-weight:900;
          outline:none;
          background:#fff;
          color:#000;
        }
        .field::placeholder{
          color:#000;
          opacity:1;
          font-weight:900;
        }

        .btns{
          display:flex;
          gap:12px;
          margin: 10px 0 18px;
          flex-wrap:wrap;
        }
        .btn{
          border: var(--border);
          background:#fff;
          color:#000;
          padding:12px 14px;
          font-weight:900;
          font-size:16px;
          cursor:pointer;
          user-select:none;
        }
        .btn:hover{ background:#000; color:#fff; }

        .btn-small{
          border: 3px solid #000;
          background:#fff;
          color:#000;
          padding:8px 10px;
          font-weight:900;
          font-size:14px;
          cursor:pointer;
          white-space:nowrap;
        }
        .btn-small:hover{ background:#000; color:#fff; }
        .btn-small[disabled]{
          opacity:.55;
          cursor:not-allowed;
        }

        .meta{
          display:flex;
          gap:12px;
          align-items:center;
          flex-wrap:wrap;
          font-weight:900;
          margin-bottom:12px;
        }
        .pill{
          border: var(--border);
          padding:8px 12px;
          font-weight:900;
        }

        .notice{
          border: var(--border);
          padding:12px 14px;
          font-weight:900;
          margin: 0 0 14px 0;
          display:none;
          background:#ccffcc;
        }

        .table-wrap{
          border: var(--border);
          overflow:auto;
          background:#fff;
        }
        table{
          width:100%;
          border-collapse:collapse;
          min-width: 800px;
        }
        th, td{
          border-bottom: 3px solid #000;
          padding:10px 12px;
          text-align:left;
          vertical-align:top;
          font-weight:900;
        }
        th{
          position:sticky;
          top:0;
          background:#fff;
          z-index:1;
        }
        tr:last-child td{ border-bottom:none; }

        .link{
          display:inline-block;
          margin-top:16px;
          font-weight:900;
          color:#1f45ff;
          text-decoration:none;
        }
        .link:hover{ text-decoration:underline; }

        tr.overdue-row td{
          background:#000;
          color:#fff;
        }

        .p{
          border: var(--border);
          padding:8px 12px;
          font-weight:900;
        }
    </style>
</head>
<body>
<main class="page">
    <section class="wrap" aria-label="Кабинет библиотекаря">
        <div class="topbar">
            <h1 class="title">Library</h1>
            <div class="who">Библиотекарь</div>
        </div>

        <div class="tabs" role="tablist" aria-label="Навигация">
            <button class="tab active" id="tabCatalog" type="button" role="tab" aria-selected="true">Каталог</button>
            <button class="tab" id="tabUsers" type="button" role="tab" aria-selected="false">Пользователи</button>
            <button class="tab" id="tabOverdue" type="button" role="tab" aria-selected="false">Просрочки</button>
        </div>

        <!-- Каталог -->
        <div class="panel active" id="panelCatalog" role="tabpanel" aria-labelledby="tabCatalog">
            <div class="notice" id="noticeCatalog"></div>
            <div class="meta">
                <div class="p" id="catalogCount">Книг: 0</div>
                <div class="p" id="totalCopies">Копий: 0</div>
            </div>
            <div class="table-wrap">
                <table>
                    <thead><tr><th>ISBN</th><th>Название</th><th>Автор</th><th>Год</th><th>Тип</th><th>Всего</th><th>Доступно</th></tr></thead>
                    <tbody id="catalogBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Пользователи -->
        <div class="panel" id="panelUsers" role="tabpanel" aria-labelledby="tabUsers">
            <div class="notice" id="noticeUsers"></div>
            <div class="row">
                <input class="field" id="userSearch" type="text" placeholder="Поиск по имени" />
            </div>
            <div class="meta">
                <div class="p" id="usersCount">Всего: 0</div>
            </div>
            <div class="table-wrap">
                <table>
                    <thead><tr><th>ID</th><th>Имя</th><th>Тип</th><th>Email</th><th>Телефон</th></tr></thead>
                    <tbody id="usersBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Просрочки -->
        <div class="panel" id="panelOverdue" role="tabpanel" aria-labelledby="tabOverdue">
            <div class="notice" id="noticeOverdue"></div>
            <div class="meta">
                <div class="p" id="overdueCount">Просроченных: 0</div>
                <div class="p" id="totalFine">Сумма штрафов: 0 ₽</div>
            </div>
            <div class="table-wrap">
                <table>
                    <thead><tr><th>Пользователь</th><th>Книга</th><th>Автор</th><th>Срок</th><th>Дней</th><th>Штраф</th></tr></thead>
                    <tbody id="overdueBody"></tbody>
                </table>
            </div>
        </div>

        <a class="link" href="login.html">Выйти</a>
    </section>
</main>

<script>
    const API_URL = 'http://localhost:8080/api';
    const FINE_PER_DAY = 10;

    function checkAuth() {
      const sessionId = localStorage.getItem('sessionId');
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      if (!sessionId || !user.userId) {
        window.location.href = 'login.html';
        return null;
      }
      return { sessionId, user };
    }
    
    const auth = checkAuth();
    if (auth) {
      document.querySelector('.who').textContent = `${auth.user.userType}\n${auth.user.name}`;
    }

    let BOOKS = [];
    let USERS = [];
    let OVERDUE_LOANS = [];

    async function loadBooksFromAPI() {
      try {
        const response = await fetch(`${API_URL}/books`);
        return await response.json();
      } catch (error) {
        console.error('Ошибка загрузки книг:', error);
        return [];
      }
    }

    async function loadUsersFromAPI() {
      try {
        const response = await fetch(`${API_URL}/users`);
        return await response.json();
      } catch (error) {
        console.error('Ошибка загрузки пользователей:', error);
        return [];
      }
    }

    async function loadOverdueLoansFromAPI() {
      try {
        const response = await fetch(`${API_URL}/loans/overdue`);
        return await response.json();
      } catch (error) {
        console.error('Ошибка загрузки просроченных:', error);
        return [];
      }
    }

    function escapeHtml(s){
      return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
    }

    function formatDate(d){
      const date = new Date(d);
      return date.toLocaleDateString('ru-RU');
    }

    function normalize(s){ return String(s).trim().toLowerCase(); }

    function showNotice(el, text){
      el.textContent = text;
      el.style.display = 'block';
      setTimeout(() => { el.style.display = 'none'; }, 4000);
    }

    function overdueDays(dueDate) {
      const due = new Date(dueDate).getTime();
      const now = Date.now();
      if (now <= due) return 0;
      return Math.ceil((now - due) / (1000 * 60 * 60 * 24));
    }

    function calcFine(dueDate) {
      const days = overdueDays(dueDate);
      return days > 0 ? days * FINE_PER_DAY : 0;
    }

    function renderCatalog(){
      document.getElementById('catalogBody').innerHTML = BOOKS.map(b => {
        return `<tr><td>${escapeHtml(b.isbn)}</td><td>${escapeHtml(b.title)}</td><td>${escapeHtml(b.author)}</td><td>${b.year}</td><td>${escapeHtml(b.type)}</td><td>${b.totalCopies}</td><td>${b.availableCopies}</td></tr>`;
      }).join('');
      document.getElementById('catalogCount').textContent = `Книг: ${BOOKS.length}`;
      const totalCopies = BOOKS.reduce((sum, b) => sum + b.totalCopies, 0);
      document.getElementById('totalCopies').textContent = `Копий: ${totalCopies}`;
    }

    function renderUsers(users){
      document.getElementById('usersBody').innerHTML = users.map(u => {
        return `<tr><td>${escapeHtml(u.userId)}</td><td>${escapeHtml(u.name)}</td><td>${escapeHtml(u.userType)}</td><td>${escapeHtml(u.email)}</td><td>${escapeHtml(u.phone)}</td></tr>`;
      }).join('');
      document.getElementById('usersCount').textContent = `Всего: ${users.length}`;
    }

    function renderOverdue(){
      const totalFine = OVERDUE_LOANS.reduce((sum, l) => sum + calcFine(l.dueAt), 0);
      document.getElementById('overdueBody').innerHTML = OVERDUE_LOANS.map(l => {
        const days = overdueDays(l.dueAt);
        const fine = calcFine(l.dueAt);
        return `<tr class="overdue-row"><td>${escapeHtml(l.userId)}</td><td>${escapeHtml(l.title)}</td><td>${escapeHtml(l.author)}</td><td>${formatDate(l.dueAt)}</td><td>${days}</td><td>${fine} ₽</td></tr>`;
      }).join('');
      document.getElementById('overdueCount').textContent = `Просроченных: ${OVERDUE_LOANS.length}`;
      document.getElementById('totalFine').textContent = `Сумма штрафов: ${totalFine} ₽`;
    }

    const tabCatalog = document.getElementById('tabCatalog');
    const tabUsers = document.getElementById('tabUsers');
    const tabOverdue = document.getElementById('tabOverdue');

    function setTab(which){
      const tabs = { 
        catalog: [tabCatalog, 'panelCatalog'], 
        users: [tabUsers, 'panelUsers'], 
        overdue: [tabOverdue, 'panelOverdue'] 
      };
      Object.values(tabs).forEach(([t, p]) => {
        t.classList.remove('active');
        t.setAttribute('aria-selected', 'false');
        document.getElementById(p).classList.remove('active');
      });
      tabs[which][0].classList.add('active');
      tabs[which][0].setAttribute('aria-selected', 'true');
      document.getElementById(tabs[which][1]).classList.add('active');
    }

    tabCatalog.addEventListener('click', () => setTab('catalog'));
    tabUsers.addEventListener('click', () => setTab('users'));
    tabOverdue.addEventListener('click', () => setTab('overdue'));

    const userSearch = document.getElementById('userSearch');
    userSearch.addEventListener('keyup', (e) => {
      const query = normalize(e.target.value);
      const filtered = USERS.filter(u => normalize(u.name).includes(query));
      renderUsers(filtered);
    });

    async function init() {
      BOOKS = await loadBooksFromAPI();
      USERS = await loadUsersFromAPI();
      OVERDUE_LOANS = await loadOverdueLoansFromAPI();
      renderCatalog();
      renderUsers(USERS);
      renderOverdue();
    }

    init();
</script>
</body>
</html>
